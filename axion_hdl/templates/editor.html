{% extends 'base.html' %}

{% block title %}Edit Module - {{ module.name }}{% endblock %}

{% block head %}
<!-- Editor-specific styles -->
<link rel="stylesheet"
    href="{{ url_for('static', filename='css/modules/editor.css') }}?v={{ range(1, 10000) | random }}">
{% endblock %}

{% block scripts %}
<!-- Global variables for editor.js -->
<script>
    const moduleIsNew = {% if module.is_new %}true{% else %} false{% endif %};
    const moduleNameGlobal = '{{ module.name }}';
    const moduleFileGlobal = '{{ module.file }}';
</script>
<script src="{{ url_for('static', filename='js/modules/editor.js') }}"></script>
{% endblock %}

{% block content %}
<!-- Unsaved Changes Indicator -->
<div id="unsavedIndicator" class="unsaved-indicator">
    <i class="bi bi-exclamation-circle"></i>
    <span>Unsaved changes</span>
</div>

<!-- Top Header -->
<div class="row align-items-center mb-4 pb-3 border-bottom g-3">
    <div class="col-12 col-md-7">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-1 small" style="--bs-breadcrumb-divider-color: var(--color-text-muted);">
                <li class="breadcrumb-item"><a href="/" class="text-decoration-none"
                        style="color: var(--color-text-secondary);">Dashboard</a></li>
                <li class="breadcrumb-item active" aria-current="page" style="color: var(--color-text-primary);">
                    {% if module.is_new %}New Module{% else %}{{ module.name }}{% endif %}
                </li>
            </ol>
        </nav>
        {% if module.is_new %}
        <div class="d-flex align-items-center gap-2">
            <input type="text" id="moduleName"
                class="form-control form-control-lg fw-bold border-0 p-0 shadow-none bg-transparent" value="new_module"
                placeholder="module_name"
                style="font-size: 1.5rem; max-width: 300px; color: var(--color-text-primary);">
            <span class="badge"
                style="background: var(--color-accent-primary); color: var(--color-bg-primary);">New</span>
        </div>
        {% else %}
        <h2 class="mb-0 fw-bold" style="color: var(--color-text-primary);">{{ module.name }}</h2>
        {% if not server_mode %}
        <small class="text-monospace d-block text-truncate"
            style="color: var(--color-text-muted); font-size: 0.8rem; max-width: 100%;">{{ module.file }}</small>
        {% endif %}
        {% endif %}
    </div>

    <div class="col-12 col-md-5 d-flex flex-wrap align-items-center justify-content-md-end gap-2">
        <span id="conflictWarning" class="badge bg-danger d-none w-100 w-md-auto mb-2 mb-md-0"><i
                class="bi bi-exclamation-triangle me-1"></i>Address Conflicts</span>

        {% if not module.is_new %}
        <button id="generateBtn" onclick="openGenerateModal()"
            class="btn btn-secondary px-3 shadow-sm fw-medium flex-grow-1 flex-md-grow-0"
            title="Generate code for this module" style="white-space: nowrap;">
            <i class="bi bi-gear-fill me-2"></i>Generate
        </button>
        {% endif %}

        <button id="saveBtn" onclick="saveChanges()"
            class="btn btn-primary px-4 shadow-sm fw-medium flex-grow-1 flex-md-grow-0" title="Review and save changes"
            style="white-space: nowrap;">
            <i class="bi bi-save2-fill me-2"></i>{% if module.is_new %}Save As...{% else %}Review & Save{% endif %}
        </button>
    </div>
</div>

<!-- Module Configuration (Compact Top Bar) -->
<div class="card border-0 shadow-sm rounded-4 mb-4"
    style="background: var(--color-bg-secondary); border: 1px solid var(--color-border) !important;">
    <div class="card-body p-4">
        <form id="moduleForm" class="row g-4 align-items-end">
            <!-- Base Address -->
            <div class="col-auto">
                <label class="form-label text-uppercase mb-2"
                    style="font-size: 0.75rem; color: var(--color-text-secondary); letter-spacing: 0.05em;">Base
                    Address</label>
                <div class="input-group">
                    <span class="input-group-text font-monospace"
                        style="background: var(--color-bg-tertiary); border-color: var(--color-border); color: var(--color-text-muted);">0x</span>
                    <input type="text" name="base_address" class="form-control font-monospace fw-bold"
                        value="{{ '%04X' % module.base_address if module.base_address else '0000' }}"
                        pattern="[0-9A-Fa-f]+" placeholder="0000" oninput="recalculateAddresses()" style="width: 80px;">
                </div>
            </div>

            <!-- CDC Enable -->
            <div class="col-auto">
                <label class="form-label text-uppercase mb-2"
                    style="font-size: 0.75rem; color: var(--color-text-secondary); letter-spacing: 0.05em;">CDC
                    Sync</label>
                <div class="form-check form-switch d-flex align-items-center mb-0 border rounded px-2"
                    style="background: var(--color-bg-tertiary); border-color: var(--color-border) !important; height: 38px;">
                    <input class="form-check-input my-0" type="checkbox" role="switch" id="cdcEnable" {% if
                        module.cdc_enabled %}checked{% endif %} onchange="toggleCDC()"
                        style="width: 2.5em; height: 1.25em; cursor: pointer;">
                    <label class="form-check-label ms-2" for="cdcEnable"
                        style="font-size: 0.9rem; cursor: pointer; color: var(--color-text-primary); white-space: nowrap;">
                        {% if module.cdc_enabled %}Enabled{% else %}Disabled{% endif %}
                    </label>
                </div>
            </div>

            <!-- CDC Stages (shown when enabled) -->
            <div class="col-auto" id="cdcSettings" {% if not module.cdc_enabled %}style="display: none;" {% endif %}>
                <label class="form-label text-uppercase mb-2"
                    style="font-size: 0.75rem; color: var(--color-text-secondary); letter-spacing: 0.05em;">Stages</label>
                <input type="number" id="cdcStages" class="form-control fw-bold" value="{{ module.cdc_stages or 2 }}"
                    min="2" max="5" style="width: 70px;">
            </div>

            <!-- Source File Info -->
            <div class="col-12 col-md-auto ms-auto text-md-end mt-3 mt-md-0">
                <label class="form-label d-block text-uppercase mb-1"
                    style="font-size: 0.75rem; color: var(--color-text-secondary); letter-spacing: 0.05em;">Source
                    File</label>
                <div class="text-truncate font-monospace small" style="color: var(--color-text-primary);">
                    {% if module.file %}
                    <a href="/source?file={{ module.file | urlencode }}"
                        class="text-decoration-none d-flex align-items-center justify-content-md-end gap-2"
                        title="{{ module.file }}" style="color: var(--color-accent-primary);">
                        <i class="bi bi-file-earmark-code"></i>
                        <span class="text-truncate" style="max-width: 300px;">{{ module.file.split('/')[-1] }}</span>
                    </a>
                    {% else %}
                    <span class="text-muted fst-italic">No source file linked</span>
                    {% endif %}
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Register Map (Full Width) -->
<div class="card border-0 shadow-sm rounded-4"
    style="background: var(--color-bg-secondary); border: 1px solid var(--color-border) !important;">
    <div class="card-header border-0 pt-4 px-4 pb-0 d-flex justify-content-between align-items-center"
        style="background: transparent;">
        <h5 class="card-title fw-bold mb-0">Register Map</h5>
        <button onclick="addRegister()" class="btn btn-sm btn-light text-primary fw-bold hover-lift" id="addRegBtn">
            <i class="bi bi-plus me-1"></i>New Register
        </button>
    </div>

    <div class="card-body p-0 mt-3">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0 table-registers" id="regsTable">
                <thead class="border-bottom">
                    <tr>
                        <th class="ps-4 py-3" style="width: 8%" data-tooltip="Calculated memory offset">Addr
                        </th>
                        <th class="py-3" style="width: 16%">Name</th>
                        <th class="py-3" style="width: 10%">Width</th>
                        <th class="py-3" style="width: 8%">Access</th>
                        <th class="py-3" style="width: 12%">Default</th>
                        <th class="py-3" style="width: 10%" data-tooltip="Read/Write Strobe signals">Strobes
                        </th>
                        <th class="py-3" style="width: 24%">Description</th>
                        <th class="pe-4 py-3 text-end" style="width: 12%">Actions</th>
                    </tr>
                </thead>
                <tbody id="regsBody" class="border-top-0">
                    {% for reg in module.registers %}
                    {% set width = 32 %}
                    {% if reg.width %}
                    {% set width = reg.width %}
                    {% elif 'vector' in reg.signal_type %}
                    {% set width = reg.signal_type.split('(')[1].split(' downto')[0] | int + 1 if '(' in
                    reg.signal_type else 32 %}
                    {% elif reg.signal_type == 'std_logic' %}
                    {% set width = 1 %}
                    {% endif %}
                    <tr class="reg-row border-bottom-0" data-index="{{ loop.index0 }}">
                        <td class="ps-4 addr-cell">
                            <div class="d-flex align-items-center gap-2">
                                {% if reg.is_packed %}
                                <i class="bi bi-chevron-right toggle-subregs expanded"
                                    onclick="toggleSubregisters(this, '{{ loop.index0 }}')" title="Show fields"></i>
                                {% else %}
                                <span style="width: 16px;"></span>
                                {% endif %}

                                <!-- Address Input: Use input for manual editing -->
                                <div class="addr-changed">
                                    <span class="addr-original" style="display: none;"></span>
                                    <input type="text"
                                        class="form-control form-control-sm font-monospace reg-addr-input border-0 bg-transparent p-0"
                                        value="0x{{ '%02X' % reg.relative_address_int }}" style="width: 70px;"
                                        data-locked="{{ 'true' if reg.manual_address else 'false' }}"
                                        data-original="0x{{ '%02X' % reg.relative_address_int }}"
                                        title="{{ 'Manual Address' if reg.manual_address else 'Auto-calculated' }}"
                                        onchange="onAddressChange(this)" onblur="onAddressBlur(this)">
                                    <button class="addr-revert-btn" style="display: none;" onclick="revertAddress(this)"
                                        data-action="revert-address" title="Revert to original">
                                        <i class="bi bi-arrow-counterclockwise"></i>
                                    </button>
                                    <span class="addr-conflict-warning" style="display: none;"><i
                                            class="bi bi-exclamation-triangle"></i></span>
                                </div>
                            </div>
                        </td>
                        <td>
                            <input type="text" value="{{ reg.reg_name or reg.signal_name }}"
                                class="form-control font-monospace reg-name-input fw-bold border-0 {% if reg.is_packed %}bg-transparent text-secondary{% else %}bg-light-subtle{% endif %}"
                                placeholder="reg_name" oninput="validateName(this)" {% if is_vhdl or reg.is_packed
                                %}readonly
                                title="{{ 'Field defined by subregisters' if reg.is_packed else 'Renaming allowed only for new registers' }}"
                                {% endif %}>
                        </td>
                        <td>
                            {% if not reg.is_packed %}
                            <div class="input-group input-group-sm">
                                <input type="number" value="{{ width }}"
                                    class="form-control reg-width-input border-0 bg-light-subtle" min="1" max="1024"
                                    style="width: 50px;" onchange="recalculateAddresses()">
                            </div>
                            {% endif %}
                        </td>
                        <td>
                            {% if not reg.is_packed %}
                            <select
                                class="form-select form-select-sm reg-access-input fw-bold border-0 bg-light-subtle
                                        {% if reg.access_mode=='RW' %}text-primary{% elif reg.access_mode=='RO' %}text-success{% else %}text-danger{% endif %}"
                                onchange="updateAccessColor(this)">
                                <option value="RW" class="text-primary" {% if reg.access_mode=='RW' %}selected{% endif
                                    %}>RW</option>
                                <option value="RO" class="text-success" {% if reg.access_mode=='RO' %}selected{% endif
                                    %}>RO</option>
                                <option value="WO" class="text-danger" {% if reg.access_mode=='WO' %}selected{% endif
                                    %}>WO</option>
                            </select>
                            {% endif %}
                        </td>
                        <td>
                            {% if not reg.is_packed %}
                            <input type="text"
                                value="0x{{ '%X' % ((reg.default_value | int) if reg.default_value is number else (reg.default_value | string | replace('0x', '') | int(base=16) if reg.default_value and reg.default_value|string|lower|replace('0x','')|length > 0 and reg.default_value|string|lower|replace('0x','')|string|int(base=16, default=None) is not none else 0)) }}"
                                class="form-control form-control-sm font-monospace reg-default-input border-0 bg-light-subtle text-secondary"
                                style="width: 100px;"
                                oninput="validateHex(this); {% if reg.is_packed %}updateSubregsFromParent(this, '{{ loop.index0 }}'){% endif %}">
                            {% endif %}
                        </td>
                        <td>
                            <div class="strobe-group">
                                <span class="strobe-toggle {{ 'active' if reg.r_strobe else 'inactive' }}"
                                    onclick="toggleStrobe(this, 'r')" data-tooltip="Read Strobe">
                                    R
                                </span>
                                <span class="strobe-toggle {{ 'active' if reg.w_strobe else 'inactive' }}"
                                    onclick="toggleStrobe(this, 'w')" data-tooltip="Write Strobe">
                                    W
                                </span>
                            </div>
                        </td>
                        <td>
                            {% if not reg.is_packed %}
                            <input type="text" value="{{ reg.description }}"
                                class="form-control form-control-sm reg-desc-input border-0 bg-transparent"
                                placeholder="Add description...">
                            {% else %}
                            <span class="text-secondary small fst-italic opacity-50">See subregisters</span>
                            <input type="hidden" class="reg-desc-input" value="{{ reg.description }}">
                            {% endif %}
                        </td>
                        <td class="pe-4 text-end">
                            <button onclick="duplicateRow(this)"
                                class="action-btn btn btn-outline-primary btn-sm border-0 bg-primary-subtle text-primary me-1"
                                title="Duplicate Register" data-tooltip="Duplicate">
                                <i class="bi bi-copy"></i>
                            </button>
                            <button onclick="deleteRow(this)"
                                class="action-btn btn btn-outline-danger btn-sm border-0 bg-danger-subtle text-danger"
                                title="Delete Register" data-tooltip="Delete">
                                <i class="bi bi-trash-fill"></i>
                            </button>
                        </td>
                    </tr>

                    {% if reg.is_packed %}
                    <tr class="subreg-details" id="subregs-{{ loop.index0 }}" style="display: table-row;">
                        <td colspan="8" class="p-0" style="background-color: var(--color-bg-secondary);">
                            <div class="position-relative ps-4 py-2 pe-3">
                                <!-- Connecting line removed -->

                                <div class="table-responsive rounded-3 overflow-hidden border"
                                    style="background-color: var(--color-bg-tertiary); border-color: var(--color-border) !important;">
                                    <table class="table table-sm mb-0 subreg-table align-middle">
                                        <thead class="text-secondary text-uppercase"
                                            style="font-size: 0.75rem; background-color: rgba(0,0,0,0.2);">
                                            <tr>
                                                <th class="ps-3 py-2 border-bottom" style="width: 20%">Field Name</th>
                                                <th class="py-2 border-bottom" style="width: 10%">Offset</th>
                                                <th class="py-2 border-bottom" style="width: 10%">Width</th>
                                                <th class="py-2 border-bottom" style="width: 12%">Range</th>
                                                <th class="py-2 border-bottom" style="width: 10%">Access</th>
                                                <th class="py-2 border-bottom" style="width: 15%">Default</th>
                                                <th class="py-2 border-bottom" style="width: 23%">Description</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for field in reg.fields %}
                                            <tr class="subreg-field-row hover-bg-light {% if field.has_error %}bg-danger-subtle border-danger{% endif %}"
                                                data-parent="{{ reg.signal_name }}" {% if field.has_error
                                                %}data-error-message="{{ field.error_message }}"
                                                title="⚠️ {{ field.error_message }}" {% endif %}>
                                                <td class="ps-3">
                                                    <div class="d-flex align-items-center">
                                                        {% if field.has_error %}
                                                        <i class="bi bi-exclamation-triangle-fill text-danger me-2 small"
                                                            data-bs-toggle="tooltip"
                                                            title="{{ field.error_message }}"></i>
                                                        {% else %}
                                                        <i class="bi bi-diagram-2 text-muted me-2 small"></i>
                                                        {% endif %}
                                                        <input type="text" value="{{ field.name }}"
                                                            class="form-control form-control-sm font-monospace subreg-name-input fw-bold bg-transparent border-0 shadow-none p-0"
                                                            placeholder="field_name">
                                                    </div>
                                                </td>
                                                <td>
                                                    <input type="number" value="{{ field.bit_low }}"
                                                        class="form-control form-control-sm subreg-offset-input border-0 bg-light-subtle text-center"
                                                        min="0" max="31" style="width: 50px;"
                                                        oninput="updateBitRange(this)">
                                                </td>
                                                <td>
                                                    <input type="number" value="{{ field.width }}"
                                                        class="form-control form-control-sm subreg-width-input border-0 bg-light-subtle text-center"
                                                        min="1" max="32" style="width: 50px;"
                                                        oninput="updateBitRange(this)">
                                                </td>
                                                <td class="font-monospace small text-muted">
                                                    <span
                                                        class="badge bg-secondary-subtle text-secondary rounded-pill border bit-range-display">
                                                        [{{ field.bit_high }}:{{ field.bit_low }}]
                                                    </span>
                                                </td>
                                                <td>
                                                    <select
                                                        class="form-select form-select-sm subreg-access-input fw-bold border-0 bg-light-subtle 
                                                        {% if field.access_mode=='RW' %}text-primary{% elif field.access_mode=='RO' %}text-success{% else %}text-danger{% endif %}"
                                                        onchange="updateAccessColor(this)">
                                                        <option value="RW"
                                                            class="{{ 'text-primary' if field.access_mode == 'RW' else '' }}"
                                                            {% if field.access_mode=='RW' %}selected{% endif %}>RW
                                                        </option>
                                                        <option value="RO"
                                                            class="{{ 'text-success' if field.access_mode == 'RO' else '' }}"
                                                            {% if field.access_mode=='RO' %}selected{% endif %}>RO
                                                        </option>
                                                        <option value="WO"
                                                            class="{{ 'text-danger' if field.access_mode == 'WO' else '' }}"
                                                            {% if field.access_mode=='WO' %}selected{% endif %}>WO
                                                        </option>
                                                    </select>
                                                </td>
                                                <td>
                                                    <input type="text" value="0x{{ '%X' % field.default_value }}"
                                                        class="form-control form-control-sm font-monospace subreg-default-input border-0 bg-light-subtle text-secondary"
                                                        oninput="validateHex(this); updateParentDefault(this)">
                                                </td>
                                                <td>
                                                    <input type="text" value="{{ field.description }}"
                                                        class="form-control form-control-sm subreg-desc-input border-0 bg-transparent ps-0"
                                                        placeholder="Description...">
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
        </div>
        </td>
        </tr>
        {% endif %}
        {% endfor %}
        </tbody>
        </table>
    </div>

    {% if not module.registers %}
    <div class="text-center py-5 text-muted" id="emptyState">
        <div class="mb-3 p-3 bg-light rounded-circle d-inline-block">
            <i class="bi bi-layers fs-1 text-secondary"></i>
        </div>
        <h5 class="fw-bold text-dark">Empty Register Map</h5>
        <p class="small">Start building your register interface via the button above.</p>
        {% endif %}
    </div>
</div>
</div>



</script>
{% endblock %}